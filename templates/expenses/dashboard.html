{% extends "base.html" %}

{% block content %}

<!-- Dashboard Header -->
<div class="dashboard-header">
    <div>
        <h1 class="dashboard-title">
            <i class="fas fa-chart-line me-2"></i>Dashboard
        </h1>
        <p class="dashboard-subtitle">Welcome back! Here's your expense overview</p>
    </div>
</div>

<!-- Action Buttons -->
<div class="action-buttons">
    <a href="{% url 'expense-add' %}" class="btn btn-success btn-lg">
        <i class="fas fa-plus me-2"></i>Add Expense
    </a>
    <a href="{% url 'expense-list' %}" class="btn btn-primary btn-lg">
        <i class="fas fa-list me-2"></i>View Expenses
    </a>
    <a href="{% url 'budget-add' %}" class="btn btn-warning btn-lg">
        <i class="fas fa-calculator me-2"></i>Set Budget
    </a>
    <a href="{% url 'category-budget-setup' %}" class="btn btn-info btn-lg">
        <i class="fas fa-tags me-2"></i>Category Budgets
    </a>
    <a href="{% url 'budget-history' %}" class="btn btn-dark btn-lg">
        <i class="fas fa-history me-2"></i>Budget History
    </a>
</div>

<!-- Stats Grid -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">Total Spending</div>
        <div class="stat-value">‚Çπ {{ total_spent }}</div>
        <small style="color: #6b7280; margin-top: 0.5rem; display: block;">
            <i class="fas fa-chart-pie me-1"></i>All time
        </small>
    </div>

    <div class="stat-card success">
        <div class="stat-label">This Month</div>
        <div class="stat-value">‚Çπ {{ monthly_spent }}</div>
        <small style="color: #6b7280; margin-top: 0.5rem; display: block;">
            <i class="fas fa-calendar me-1"></i>Current period
        </small>
    </div>

    <div class="stat-card warning">
        <div class="stat-label">Predicted Next Month</div>
        <div class="stat-value">‚Çπ {{ predicted_next_month }}</div>
        <small style="color: #6b7280; margin-top: 0.5rem; display: block;">
            <i class="fas fa-crystal-ball me-1"></i>AI Prediction
        </small>
    </div>
</div>

<!-- Category-wise Budget Breakdown -->
{% if category_budget_data %}
<div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="fas fa-chart-pie me-2"></i>Category Budget Breakdown</span>
        <a href="{% url 'category-budget-setup' %}" class="btn btn-sm btn-primary">
            <i class="fas fa-edit"></i> Edit Budgets
        </a>
    </div>
    <div class="card-body">
        <div class="row">
            {% for item in category_budget_data %}
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card border-left-{{ item.status }}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="mb-0">
                                <i class="fas fa-tag text-{{ item.status }}"></i>
                                {{ item.category.name }}
                            </h5>
                            <a href="{% url 'expense-add' %}?category={{ item.category.id }}" 
                               class="btn btn-sm btn-outline-primary"
                               title="Add expense to {{ item.category.name }}">
                                <i class="fas fa-plus"></i>
                            </a>
                        </div>
                        
                        <div class="mb-2">
                            <div class="d-flex justify-content-between text-sm">
                                <span class="text-muted">Budget:</span>
                                <strong class="text-primary">‚Çπ{{ item.budget|floatformat:2 }}</strong>
                            </div>
                            <div class="d-flex justify-content-between text-sm">
                                <span class="text-muted">Spent:</span>
                                <strong class="text-{{ item.status }}">‚Çπ{{ item.spent|floatformat:2 }}</strong>
                            </div>
                            <div class="d-flex justify-content-between text-sm">
                                <span class="text-muted">Remaining:</span>
                                <strong class="{% if item.remaining < 0 %}text-danger{% else %}text-success{% endif %}">
                                    ‚Çπ{{ item.remaining|floatformat:2 }}
                                </strong>
                            </div>
                        </div>
                        
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-{{ item.status }}"
                                 role="progressbar"
                                 style="width: {% if item.percentage > 100 %}100{% else %}{{ item.percentage }}{% endif %}%"
                                 aria-valuenow="{{ item.percentage }}"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                            </div>
                        </div>
                        <div class="text-center mt-1">
                            <small class="text-{{ item.status }} fw-bold">{{ item.percentage }}%</small>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        {% if total_category_budget > 0 %}
        <div class="alert alert-info mt-3 mb-0">
            <strong>Total Category Budget:</strong> ‚Çπ{{ total_category_budget|floatformat:2 }}
            {% if budget_amount > 0 %}
            | <strong>Monthly Budget:</strong> ‚Çπ{{ budget_amount|floatformat:2 }}
            | <strong>Unallocated:</strong> ‚Çπ{{ unallocated_budget|floatformat:2 }}
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Category Breakdown Chart -->
<div class="card">
    <div class="card-header">
        <i class="fas fa-chart-doughnut me-2"></i>Spending by Category
    </div>
    <div class="card-body">
        <canvas id="categoryChart" style="max-height: 300px;"></canvas>
    </div>
</div>

<!-- Budget Overview -->
<div class="row mt-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-wallet me-2"></i>Monthly Budget
            </div>
            <div class="card-body">
                <div style="font-size: 2.5rem; font-weight: 700; color: #4f46e5;">
                    ‚Çπ {{ budget_amount }}
                </div>
                <small style="color: #6b7280;">Total budget allocated for this month</small>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-check-circle me-2"></i>Remaining Amount
            </div>
            <div class="card-body">
                <div style="font-size: 2.5rem; font-weight: 700; color: #10b981;">
                    ‚Çπ {{ remaining_amount }}
                </div>
                <small style="color: #6b7280;">Available to spend this month</small>
            </div>
        </div>
    </div>
</div>

<!-- Budget Progress -->
<div class="card mt-4">
    <div class="card-header">
        <i class="fas fa-tasks me-2"></i>Budget Usage Progress
    </div>
    <div class="card-body">
        {% if percentage_used > 100 %}
            <div class="alert alert-danger mb-3">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Alert!</strong> You have exceeded your monthly budget!
            </div>
        {% elif percentage_used > 75 %}
            <div class="alert alert-warning mb-3">
                <i class="fas fa-exclamation-circle me-2"></i>
                <strong>Warning!</strong> You're using 75% of your budget. Be careful!
            </div>
        {% endif %}
        
        <div style="margin-bottom: 1rem;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="color: #6b7280;">Budget Usage</span>
                <span style="font-weight: 700; font-size: 1.25rem;">{{ percentage_used }}%</span>
            </div>
        </div>
        
        <div class="progress" style="height: 12px; border-radius: 10px; background-color: #e5e7eb;">
            <div class="progress-bar 
                {% if percentage_used > 100 %}
                    bg-danger
                {% elif percentage_used > 75 %}
                    bg-warning
                {% else %}
                    bg-success
                {% endif %}"
                role="progressbar"
                style="width: {% if percentage_used > 100 %}100{% else %}{{ percentage_used }}{% endif %}%; border-radius: 10px;">
            </div>
        </div>
    </div>
</div>

<!-- Chart Script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<script>
    const ctx = document.getElementById("categoryChart").getContext('2d');
    const data = {
        labels: [
            {% for item in category_data %}
                "{{ item.category__name }}",
            {% endfor %}
        ],
        datasets: [{
            data: [
                {% for item in category_data %}
                    {{ item.total }},
                {% endfor %}
            ],
            backgroundColor: [
                '#6366f1',
                '#10b981',
                '#f59e0b',
                '#ef4444',
                '#8b5cf6',
                '#06b6d4',
                '#ec4899',
                '#14b8a6',
            ],
            borderColor: '#ffffff',
            borderWidth: 2,
        }]
    };

    new Chart(ctx, {
        type: "doughnut",
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        font: {
                            size: 13,
                            weight: '600'
                        },
                        padding: 15,
                        usePointStyle: true,
                    }
                }
            }
        }
    });
</script>

<script>
    // Onboarding Tour for New Users
    document.addEventListener('DOMContentLoaded', function() {
        // Check if user has seen the tour (stored in localStorage)
        const hasSeenTour = localStorage.getItem('dashboard_tour_completed');
        
        // Only show tour if user hasn't seen it and has no expenses
        const totalSpent = {{ total_spent|default:0 }};
        
        if (!hasSeenTour && totalSpent === 0) {
            // Show tour after a short delay
            setTimeout(function() {
                startOnboardingTour();
            }, 1000);
        }
    });

    function startOnboardingTour() {
        introJs().setOptions({
            steps: [
                {
                    title: 'Welcome! üëã',
                    intro: 'Welcome to AI Expense Manager! Let me show you around in under 30 seconds.'
                },
                {
                    element: document.querySelector('.action-buttons'),
                    title: 'Quick Actions',
                    intro: 'These buttons give you quick access to key features. Start by adding your first expense!'
                },
                {
                    element: document.querySelector('.stats-grid'),
                    title: 'Your Stats',
                    intro: 'Track your total spending, monthly expenses, and AI-powered forecasts here.'
                },
                {
                    element: document.querySelector('.chart-container'),
                    title: 'Spending Breakdown',
                    intro: 'Visualize where your money goes with beautiful charts (they\'ll appear once you add expenses).'
                },
                {
                    element: document.querySelector('.navbar'),
                    title: 'Navigation',
                    intro: 'Use the navigation bar to access Expenses, Categories, and Budgets anytime.'
                },
                {
                    title: 'Get Started! üöÄ',
                    intro: 'Ready to take control of your finances? Click "Add Expense" to begin tracking!'
                }
            ],
            showProgress: true,
            showBullets: false,
            exitOnOverlayClick: false,
            doneLabel: 'Get Started',
            nextLabel: 'Next ‚Üí',
            prevLabel: '‚Üê Back'
        }).oncomplete(function() {
            // Mark tour as completed
            localStorage.setItem('dashboard_tour_completed', 'true');
            showToast('Tour completed! Ready to start tracking expenses.', 'success');
        }).onexit(function() {
            // User skipped the tour
            localStorage.setItem('dashboard_tour_completed', 'true');
        }).start();
    }

    // Add a button to restart the tour (for testing or if user wants to see it again)
    function restartTour() {
        localStorage.removeItem('dashboard_tour_completed');
        startOnboardingTour();
    }
</script>

{% endblock %}