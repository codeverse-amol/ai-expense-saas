{% extends 'base.html' %}
{% load static %}

{% block title %}Set Category Budgets{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-chart-pie"></i> Set Category Budgets</h1>
    <p class="text-muted">Allocate your monthly budget across categories - {{ month }}/{{ year }}</p>
</div>

{% if monthly_budget %}
<div class="alert alert-info mb-4">
    <i class="fas fa-info-circle"></i>
    <strong>Monthly Budget:</strong> ₹{{ monthly_budget.amount|floatformat:2 }}
    {% if total_allocated > 0 %}
    | <strong>Allocated:</strong> ₹{{ total_allocated|floatformat:2 }}
    | <strong>Remaining:</strong> ₹{{ monthly_budget.amount|add:"-"|add:total_allocated|floatformat:2 }}
    {% endif %}
</div>
{% else %}
<div class="alert alert-warning mb-4">
    <i class="fas fa-exclamation-triangle"></i>
    You haven't set a monthly budget for {{ month }}/{{ year }} yet.
    <a href="{% url 'budget-add' %}" class="alert-link">Set Monthly Budget First</a>
</div>
{% endif %}

{% if categories %}
<form method="post" id="categoryBudgetForm">
    {% csrf_token %}
    <input type="hidden" name="year" value="{{ year }}">
    <input type="hidden" name="month" value="{{ month }}">
    
    <div class="row">
        {% for category in categories %}
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="card">
                <div class="card-body">
                    <label for="budget_{{ category.id }}" class="form-label">
                        <i class="fas fa-tag text-primary"></i>
                        <strong>{{ category.name }}</strong>
                    </label>
                    <div class="input-group">
                        <span class="input-group-text">₹</span>
                        <input 
                            type="number" 
                            class="form-control budget-input" 
                            id="budget_{{ category.id }}"
                            name="budget_{{ category.id }}"
                            value="{{ category.current_budget|default:'0' }}"
                            step="0.01"
                            min="0"
                            placeholder="0.00"
                        >
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <div class="card mt-4 bg-light">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="mb-0">
                        Total Allocation: <span class="text-primary" id="totalAllocation">₹0.00</span>
                    </h5>
                    {% if monthly_budget %}
                    <small class="text-muted">
                        Out of ₹{{ monthly_budget.amount|floatformat:2 }}
                    </small>
                    {% endif %}
                </div>
                <div class="col-md-6 text-md-end">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Category Budgets
                    </button>
                    <a href="{% url 'dashboard' %}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancel
                    </a>
                </div>
            </div>
        </div>
    </div>
</form>
{% else %}
<div class="alert alert-info">
    <i class="fas fa-info-circle"></i>
    <strong>No categories yet!</strong> 
    <a href="{% url 'category-add' %}" class="alert-link">Create categories</a> first to set budgets.
</div>
{% endif %}

<script>
// Calculate total allocation dynamically
document.addEventListener('DOMContentLoaded', function() {
    const budgetInputs = document.querySelectorAll('.budget-input');
    const totalDisplay = document.getElementById('totalAllocation');
    
    function updateTotal() {
        let total = 0;
        budgetInputs.forEach(input => {
            const value = parseFloat(input.value) || 0;
            total += value;
        });
        totalDisplay.textContent = '₹' + total.toFixed(2);
    }
    
    budgetInputs.forEach(input => {
        input.addEventListener('input', updateTotal);
    });
    
    updateTotal(); // Initial calculation
});
</script>

{% endblock %}
